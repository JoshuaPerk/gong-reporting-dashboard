<!DOCTYPE html>
<html>
  <head>
    <title>Google Sheets API Quickstart</title>
    <meta charset="utf-8" />
  </head>
  <body>
    <p>Google Sheets API Quickstart</p>

    <!--Add buttons to initiate auth sequence and sign out-->
    <button id="authorize_button" style="display: none;">Authorize</button>
    <button id="signout_button" style="display: none;">Sign Out</button>

    <pre id="content" style="white-space: pre-wrap;"></pre>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>


    <script type="text/javascript">
      var CLIENT_ID = '393986627865-du66b48n8dtc1iscfnqh4olp1qp47otk.apps.googleusercontent.com';
      var API_KEY = 'AIzaSyC4L_BND_f8ApeMY4_8sLNs7uKhPeCX4ac';
      var DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
      var SCOPES = "https://www.googleapis.com/auth/spreadsheets.readonly";
      var authorizeButton = document.getElementById('authorize_button');
      var signoutButton = document.getElementById('signout_button');
      let team;

      function resetDataLayer(){
        team = {
          "numberOfQuestionRequests": 0,
          "questionValue": 0,
          "questionOwners": {},
          "questionOrgUsage": {},
          "questionUnitUsage": {},
          "users": [
            {"name":"William Kiley","unit":"SMB","org":"Sales","slackID":""},
            {"name":"Michael Rogewitz","unit":"SMB","org":"Sales","slackID":""},
            {"name":"Maddie Gauthier","unit":"SMB","org":"Sales","slackID":""},
            {"name":"Jeff Sullivan","unit":"INT","org":"Sales","slackID":"jsullivan"},
            {"name":"Mari O'Leary","unit":"SME","org":"Sales","slackID":""},
            {"name":"Max Sandoval","unit":"SME","org":"AM","slackID":"msandoval"},
            {"name":"Collin O'Brien","unit":"SMB","org":"AM","slackID":""},
            {"name":"Madelyn Ligtenberg","unit":"SMB","org":"Sales","slackID":""},
            {"name":"Nick Brown","unit":"SME","org":"AM","slackID":""},
            {"name":"Jeff Andrew Mabute-Louie","unit":"SME","org":"Sales","slackID":""},
            {"name":"Stephanie Durocher","unit":"SMB","org":"Sales","slackID":""},
            {"name":"Ciaran Nugent","unit":"SMB","org":"Sales","slackID":""},
            {"name":"Michael Pantano","unit":"SMB","org":"Sales","slackID":""},
            {"name":"Courtney Thompson","unit":"SMB","org":"Sales","slackID":""},
            {"name":"Steve Palombo","unit":"SME","org":"Sales","slackID":""},
            {"name":"Hambisa Goso","unit":"SME","org":"Sales","slackID":"hgoso"},
            {"name":"Ryan Heavey","unit":"SME","org":"Sales","slackID":"rheavey"},
            {"name":"Michael Grundig","unit":"SMB","org":"Sales","slackID":"mgrundig"},
            {"name":"Dan Salvetti","unit":"SME","org":"Sales","slackID":""},
            {"name":"Nick Christolos","unit":"SME","org":"Sales","slackID":""},
            {"name":"Kerry Harris","unit":"SME","org":"Sales","slackID":""},
            {"name":"Bryan Blaha","unit":"SME","org":"Sales","slackID":""},
            {"name":"Sean Kenny","unit":"SME","org":"AM","slackID":""},
            {"name":"Aaron Roberts","unit":"INT","org":"Sales","slackID":"aroberts"},
            {"name":"Ally Bresnahan","unit":"SME","org":"Sales","slackID":""},
            {"name":"Jason Mercer","unit":"SMB","org":"Sales","slackID":""},
            {"name":"Lindsey Riordan","unit":"SMB","org":"Sales","slackID":"lriordan"},
            {"name":"Sawyer Dew","unit":"SMB","org":"Sales","slackID":""},
            {"name":"Tucker Cohen","unit":"SME","org":"Partner","slackID":""},
            {"name":"Claire Kennedy","unit":"SMB","org":"Sales","slackID":""},
            {"name":"John Murphy","unit":"SMB","org":"Sales","slackID":"jmurphy"},
            {"name":"David Johnson","unit":"SMB","org":"Sales","slackID":"davidjohnson1562"},
            {"name":"Erin Silva","unit":"INT","org":"CSM","slackID":"esilva"},
            {"name":"Christina Nalband","unit":"SME","org":"Sales","slackID":""},
            {"name":"Katie Ferris","unit":"Siftrock","org":"Sales","slackID":""},
            {"name":"Alex Hanbury","unit":"ENT","org":"Sales","slackID":"ahanbury"},
            {"name":"Ryan Topal","unit":"SMB","org":"Sales","slackID":"ryan.topal"},
            {"name":"Derek Kelliher","unit":"ENT","org":"Sales","slackID":""},
            {"name":"Robert Boerrigter","unit":"SMB","org":"Sales","slackID":"rboerrigter"},
            {"name":"Eve Pham","unit":"SMB","org":"Sales","slackID":""},
            {"name":"Tyler Guzzi","unit":"SMB","org":"Sales","slackID":"tguzzi"},
            {"name":"Reed Wazorko","unit":"SME","org":"AM","slackID":""},
            {"name":"Kelvin Sims","unit":"SMB","org":"Sales","slackID":"ksims"},
            {"name":"James Pidgeon","unit":"SMB","org":"Sales","slackID":""},
            {"name":"Joe Dell'Erario","unit":"SMB","org":"Sales","slackID":"jdellerario"},
            {"name":"Evan Cassidy","unit":"ENT","org":"Sales","slackID":"ecassidy"},
            {"name":"Vittorio Monteverdi","unit":"SMB","org":"Sales","slackID":"vmonteverdi"},
            {"name":"Tanner Fogarty","unit":"ENT","org":"Sales","slackID":""},
            {"name":"Brendan Collins","unit":"SME","org":"AM","slackID":"bcollins"},
            {"name":"Katy Zingale","unit":"SME","org":"AM","slackID":"kzingale"},
            {"name":"Molly Dexter","unit":"SME","org":"Sales","slackID":""},
            {"name":"Jordan Pal","unit":"SMB","org":"Sales","slackID":""},
            {"name":"Brad Forgetta","unit":"ENT","org":"Sales","slackID":""},
            {"name":"Bennett Boucher","unit":"SME","org":"Sales","slackID":""},
            {"name":"Trent Mosley","unit":"SME","org":"Partner","slackID":""},
            {"name":"Miles Kane","unit":"SMB","org":"Sales","slackID":""},
            {"name":"Allen Knox","unit":"ENT","org":"Sales","slackID":"aknox8781"},
            {"name":"Kelly Barnett","unit":"SME","org":"Sales","slackID":"kbarnett"},
            {"name":"Adam Cox","unit":"SME","org":"Sales","slackID":""},
            {"name":"Lincoln Brown","unit":"SME","org":"Sales","slackID":"lbrown3382"},
            {"name":"Adrian Nardella","unit":"SMB","org":"CSM","slackID":""},
            {"name":"Lilly Steeves","unit":"SME","org":"Sales","slackID":""},
            {"name":"Paul Axelrod","unit":"SMB","org":"Sales","slackID":""},
            {"name":"Amanda Chiang","unit":"ENT","org":"Sales","slackID":""},
            {"name":"Sara Miller","unit":"SME","org":"Sales","slackID":""},
            {"name":"Shannon Donovan","unit":"SME","org":"Sales","slackID":"sdonovan"},
            {"name":"Elliott Thomas","unit":"SMB","org":"CSM","slackID":"ejthomas2390"},
            {"name":"Blake Kelly","unit":"SME","org":"Sales","slackID":"bkelly"},
            {"name":"Jason Phillips","unit":"SME","org":"AM","slackID":"jbprugby"},
            {"name":"Michele Albanese","unit":"Siftrock","org":"CSM","slackID":""},
            {"name":"Adrianne Ober","unit":"SME","org":"CSM","slackID":"bostonadrianne"},
            {"name":"Alex Lemieux","unit":"ENT","org":"CSM","slackID":"alemieux"},
            {"name":"Amanda Arthur","unit":"ENT","org":"AM","slackID":""},
            {"name":"Bailey Best","unit":"SME","org":"CSM","slackID":"bbest"},
            {"name":"Caitlin Sullivan","unit":"ENT","org":"CSM","slackID":""},
            {"name":"Christine Hayden","unit":"ENT","org":"CSM","slackID":""},
            {"name":"Daniel Salvetti","unit":"SME","org":"Sales","slackID":"dsalvetti"},
            {"name":"Elizabeth Glavan","unit":"SME","org":"CSM","slackID":"eglavan"},
            {"name":"Erin Washburn","unit":"ENT","org":"CSM","slackID":""},
            {"name":"Jaclyn Van","unit":"SMB","org":"CSM","slackID":"jvan"},
            {"name":"Jacqueline McLaughlin","unit":"SMB","org":"Sales","slackID":"jmclaughlin"},
            {"name":"Jason Richman","unit":"SME","org":"Sales","slackID":""},
            {"name":"Jon Ravesi","unit":"SME","org":"Partner","slackID":""},
            {"name":"Joshua Perk","unit":"ENT","org":"Sales","slackID":""},
            {"name":"Ken Shin","unit":"ENT","org":"AM","slackID":""},
            {"name":"Kristine O'Brien","unit":"SME","org":"CSM","slackID":""},
            {"name":"Lottie Hedden","unit":"ENT","org":"CSM","slackID":""},
            {"name":"Mary Mitchell","unit":"ENT","org":"Sales","slackID":""},
            {"name":"Mike Gotera","unit":"ENT","org":"CSM","slackID":""},
            {"name":"Molly Head","unit":"ENT","org":"CSM","slackID":""},
            {"name":"Nate Hoffelmeyer","unit":"ENT","org":"CSM","slackID":""},
            {"name":"Nathan Chein","unit":"ENT","org":"CSM","slackID":""},
            {"name":"Neil Fiedler","unit":"SME","org":"AM","slackID":"nfiedler"},
            {"name":"Robert Perez","unit":"SME","org":"Sales","slackID":""},
            {"name":"Sam Gifford","unit":"Siftrock","org":"Sales","slackID":""},
            {"name":"Seamus McGrath","unit":"SME","org":"Partner","slackID":""},
            {"name":"Sebastean Gonzalez-Johnson","unit":"SMB","org":"Sales","slackID":""},
            {"name":"Sophie Teraoka","unit":"ENT","org":"CSM","slackID":"sophie.teraoka"},
            {"name":"Taylor Miller","unit":"ENT","org":"CSM","slackID":""},
          ]
        };
      };

      function isNumber (value) {
        if (typeof value !== 'number') {
          return false
        }
        if (value !== Number(value)) {
          return false
        }
        if (Number.isFinite(value) === false) {
          return false
        }
        return true
      }

      function handleClientLoad() {
        gapi.load('client:auth2', initClient);
      }

      function initClient() {
        gapi.client.init({
          apiKey: API_KEY,
          clientId: CLIENT_ID,
          discoveryDocs: DISCOVERY_DOCS,
          scope: SCOPES
        }).then(function () {
          gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
          updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
          authorizeButton.onclick = handleAuthClick;
          signoutButton.onclick = handleSignoutClick;
        }, function(error) {
          appendPre(JSON.stringify(error, null, 2));
        });
      }

      function updateSigninStatus(isSignedIn) {
        if (isSignedIn) {
          authorizeButton.style.display = 'none';
          signoutButton.style.display = 'block';
          getQuestionRequests();
        } else {
          authorizeButton.style.display = 'block';
          signoutButton.style.display = 'none';
        }
      }

      function handleAuthClick(event) {
        gapi.auth2.getAuthInstance().signIn();
      }

      function handleSignoutClick(event) {
        gapi.auth2.getAuthInstance().signOut();
      }

      function appendPre(message) {
        var pre = document.getElementById('content');
        var textContent = document.createTextNode(message + '\n');
        pre.appendChild(textContent);
      }

      function getQuestionRequests() {
        resetDataLayer();
        gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: '13q20Tw_8yrH0fDMnFZU-_5OoiJgIT8zW1-_IOA1IZxk',
          range: 'Questions!A2:I',
        }).then(function(response) {
          team.numberOfQuestionRequests = response.result.values.length;
          response.result.values.forEach(function(question){
            var userLookup = team.users.find(obj => {
              return obj.slackID == question[1]
            });
            if (userLookup) {
              team.questionOrgUsage[userLookup.org] = (team.questionOrgUsage[userLookup.org] || 1) + 1;
              team.questionUnitUsage[userLookup.unit] = (team.questionUnitUsage[userLookup.unit] || 1) + 1;
            } else {
              console.log('Could not map user: ', question[1]);
            }
            team.questionOwners[question[1]] = (team.questionOwners[question[1]] || 1) + 1;
            if (isNumber(parseFloat(Number(question[6].replace(/[^0-9.-]+/g,""))))) {
              team.questionValue += Math.abs(parseFloat(Number(question[6].replace(/[^0-9.-]+/g,""))));
            }
          });
        }, function(response) {
          appendPre('Error: ' + response.result.error.message);
        });
      }

    </script>

    <script async defer src="https://apis.google.com/js/api.js"
      onload="this.onload=function(){};handleClientLoad()"
      onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>
  </body>
</html>
